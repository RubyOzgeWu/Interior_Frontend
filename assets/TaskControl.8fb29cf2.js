import{c,Q as q}from"./QBtn.2b28443b.js";import{d as V,e as g}from"./QItem.7578c6c1.js";import{Q as $}from"./QInput.1e5fd9dd.js";import{u as ie,Q as me}from"./use-quasar.39101c37.js";import{Q as pe,c as fe,d as ve,e as z,f as ke,g as we,C as G}from"./ClosePopup.041839ef.js";import{a4 as _e,r,n as ye,p as i,a2 as H,u as n,x as s,a6 as be,a0 as m,ae as D,f as t,q as w,ad as P,F as B,N,a1 as Ve,v as he,O as f,E as Ce,a3 as J}from"./index.6f2eea83.js";import{u as ge,a as S,b as h}from"./user.c6eb2d70.js";import"./use-dark.793a1017.js";const $e={id:"task-control"},De={class:"task-wrapper"},Qe={class:"header"},Ue=s("span",null,"\u7559\u8A00\u677F",-1),je={class:"content"},xe={class:"task-date"},Fe={class:"task-remark"},Ie={class:"uploaded-files"},Oe={class:"col-10"},Re=s("h5",null,"\u7559\u8A00\u677F",-1),Te={key:0,class:"comments-account row"},Pe={class:"comments-board-wrapper"},Be=s("div",{class:"comments-board-header row justify-between items-center"},[s("h5",null,"\u7559\u8A00\u677F")],-1),Ne={key:0,class:"comments-account row"},Se=s("div",{class:"text-h4",style:{"font-weight":"700",color:"#2466e2"}}," \u7DE8\u8F2F\u4EFB\u52D9 ",-1),Ee={class:"row items-center justify-end"},We={__name:"TaskControl",setup(Le){const E=_e(),u=r(""),d=r(""),K=r(null),F=r(null),W=r(null),I=r(null),v=r({_id:"",name:"",date:"",status:"\u6E96\u5099\u4E2D",owner:{label:"",value:""},remark:"",files:[],__v:0}),X=l=>({"status-preparing":l==="\u6E96\u5099\u4E2D","status-in-progress":l==="\u9032\u884C\u4E2D","status-done":l==="\u5DF2\u5B8C\u6210","status-expired":l==="\u5DF2\u903E\u671F"}),L=r([]),Y=["\u6E96\u5099\u4E2D","\u9032\u884C\u4E2D","\u5DF2\u5B8C\u6210","\u5DF2\u903E\u671F"],Q=r(!1),o=ye({_id:"",name:"",date:"2024/02/01",status:"\u6E96\u5099\u4E2D",owner:"",remark:""}),Z=l=>{ee(l),Q.value=!0},ee=l=>{for(const e in o)Object.prototype.hasOwnProperty.call(o,e)&&Object.prototype.hasOwnProperty.call(l,e)&&(o[e]=l[e])},ae=async()=>{const l={name:o.name,date:o.date,status:o.status,owner:{label:o.owner.label,value:o.owner.value},remark:o.remark};try{await h.patch(`/projects/${d.value}/tasks/${o._id}`,l),alert("\u5132\u5B58\u6210\u529F"),Q.value=!1,await C()}catch{alert("\u5132\u5B58\u5931\u6557")}},te=r(!1),U=r(null),O=r([]),le=()=>{U.value.click()},se=async()=>{U.value.files.length>0&&await M()},M=async()=>{const l=U.value.files[0],e=new FormData;e.append("file",l,l.name),e.append("taskId",u.value);try{const a=await S.post(`/projects/${d.value}/tasks/${u.value}/upload`,e,{headers:{"Content-Type":"multipart/form-data"}});alert("\u4E0A\u50B3\u6210\u529F"),O.value.push(a.data.file),await C()}catch{alert("\u4E0A\u50B3\u5931\u6557")}},oe=l=>{confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6A94\u6848 \uFF1F")&&ne(l)},ne=async l=>{try{await h.delete(`/projects/${d.value}/tasks/${u.value}/files/${l}`),alert("\u522A\u9664\u6210\u529F"),await C()}catch(e){throw new Error("\u522A\u9664\u6587\u4EF6\u51FA\u932F:",e)}},re=async l=>{try{const e=await S.get(`/projects/${d.value}/tasks/${u.value}/files/${l}`,{responseType:"blob"});let a="downloaded_file";const y=e.headers["content-disposition"];if(y){const b=y.match(/filename\*?=([^;]+)/);b&&b[1]&&(a=decodeURIComponent(b[1].replace(/^UTF-8''/,"")))}const T=window.URL.createObjectURL(new Blob([e.data])),k=document.createElement("a");k.href=T,k.setAttribute("download",a),document.body.appendChild(k),k.click(),document.body.removeChild(k),window.URL.revokeObjectURL(T),alert("\u4E0B\u8F09\u6210\u529F")}catch{alert("\u4E0B\u8F09\u5931\u6557")}},ue=ie(),j=r(!ue.screen.lt.lg);function de(){j.value=!j.value}const R=r([]),p=ge(),_=r(""),A=async l=>{try{const e={comment:_.value};await h.post(`/projects/${d.value}/tasks/${u.value}/${l}/comment`,e),_.value="",await C(),Ce(()=>{F.value&&F.value.scrollIntoView({behavior:"smooth"}),I.value&&I.value.scrollIntoView({behavior:"smooth"})})}catch(e){alert("\u65B0\u589E\u5931\u6557"),console.error(e)}},C=async()=>{try{d.value=E.params.projectId,u.value=E.params.taskId;const{data:l}=await S.get(`/projects/${d.value}/tasks/${u.value}`);v.value=l,u.value=l._id;const[e,a,y]=await Promise.all([h.get("/users/all"),h.get(`/projects/${d.value}/tasks/${u.value}/files`),h.get(`/projects/${d.value}/tasks/${u.value}/comments`)]),k=e.data.result.map(x=>({label:x.account,value:x._id}));L.value=k,O.value=a.data.files;const b=y.data;b.sort((x,ce)=>new Date(x.timestamp)-new Date(ce.timestamp)),R.value=b}catch{alert("\u8F09\u5165\u932F\u8AA4")}};return C(),(l,e)=>(i(),H(pe,null,{default:n(()=>[s("div",$e,[s("div",De,[s("div",Qe,[s("h5",null,[be(m(v.value.name)+" ",1),s("span",{class:D(["task-status",X(v.value.status)])},m(v.value.status),3)]),t(c,{class:"btn-comments",onClick:de,icon:"assignment"},{default:n(()=>[Ue]),_:1})]),s("div",je,[s("p",xe,"\u4EA4\u4ED8\u65E5\u671F\uFF1A"+m(v.value.date),1),t(g,{class:"task-info",flat:""},{default:n(()=>[t(c,{icon:"edit",onClick:e[0]||(e[0]=a=>Z(v.value)),flat:"",dense:"",round:""}),t(V,null,{default:n(()=>[s("div",Fe,m(v.value.remark),1)]),_:1})]),_:1}),t(c,{class:"btn-add-files",icon:"add",dense:"",onClick:le}),s("div",Ie,[(i(!0),w(B,null,P(O.value,a=>(i(),H(g,{key:a,flat:"",class:"uploaded-file",onDblclick:y=>re(a._id)},{default:n(()=>[t(V,{class:"row items-center"},{default:n(()=>[t(q,{name:"upload_file",class:"col-1"}),s("p",Oe,m(a.fileName),1),t(c,{class:"btn-delete-files col-1",icon:"close",flat:"",dense:"",onClick:y=>oe(a._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["onDblclick"]))),128))]),N(s("form",{onSubmit:he(M,["prevent"])},[s("input",{type:"file",ref_key:"fileInput",ref:U,onChange:se,style:{display:"none"}},null,544)],544),[[Ve,te.value]])])]),t(me,{modelValue:j.value,"onUpdate:modelValue":e[3]||(e[3]=a=>j.value=a),side:"right",bordered:"",width:500,class:"pad-comments-board-wrapper"},{default:n(()=>[Re,t(g,{ref_key:"padCommentsContainer",ref:W,class:"pad-comments-container row",flat:""},{default:n(()=>[t(V,null,{default:n(()=>[(i(!0),w(B,null,P(R.value,a=>(i(),w("div",{class:D(["comments-container column",{"my-comment":a.account===f(p).account}]),key:a},[a.account!==f(p).account?(i(),w("div",Te,[s("p",null,m(a.account),1)])):J("",!0),s("div",{class:D(["comments-text row",{"my-comment":a.account===f(p).account}])},[s("p",null,m(a.text),1)],2)],2))),128)),s("div",{ref_key:"scrollMarkerPad",ref:I},null,512)]),_:1})]),_:1},512),t($,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=a=>_.value=a),label:"\u8F38\u5165\u8A0A\u606F",type:"textarea",filled:"",autogrow:""},{after:n(()=>[t(c,{round:"",dense:"",flat:"",icon:"send",onClick:e[1]||(e[1]=a=>A(f(p).id))})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]),s("div",Pe,[Be,t(g,{ref_key:"commentsBoardContent",ref:K,class:"comments-board-content row",flat:""},{default:n(()=>[t(V,null,{default:n(()=>[(i(!0),w(B,null,P(R.value,a=>(i(),w("div",{class:D(["comments-container column",{"my-comment":a.account===f(p).account}]),key:a},[a.account!==f(p).account?(i(),w("div",Ne,[s("p",null,m(a.account),1)])):J("",!0),s("div",{class:D(["comments-text row",{"my-comment":a.account===f(p).account}])},[s("p",null,m(a.text),1)],2)],2))),128)),s("div",{ref_key:"scrollMarker",ref:F},null,512)]),_:1})]),_:1},512),t($,{modelValue:_.value,"onUpdate:modelValue":e[5]||(e[5]=a=>_.value=a),label:"\u8F38\u5165\u8A0A\u606F",type:"textarea",filled:"",autogrow:"",dense:""},{after:n(()=>[t(c,{round:"",dense:"",flat:"",icon:"send",onClick:e[4]||(e[4]=a=>A(f(p).id))})]),_:1},8,["modelValue"])])]),t(we,{modelValue:Q.value,"onUpdate:modelValue":e[13]||(e[13]=a=>Q.value=a),persistent:""},{default:n(()=>[t(g,{class:"add-form"},{default:n(()=>[t(V,null,{default:n(()=>[Se]),_:1}),t(V,null,{default:n(()=>[t($,{modelValue:o.name,"onUpdate:modelValue":e[6]||(e[6]=a=>o.name=a),label:"\u4EFB\u52D9\u540D\u7A31"},null,8,["modelValue"]),t($,{modelValue:o.date,"onUpdate:modelValue":e[8]||(e[8]=a=>o.date=a),mask:"date",rules:["date"]},{append:n(()=>[t(q,{name:"event",class:"cursor-pointer"},{default:n(()=>[t(fe,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[t(ve,{modelValue:o.date,"onUpdate:modelValue":e[7]||(e[7]=a=>o.date=a)},{default:n(()=>[s("div",Ee,[N(t(c,{label:"Close",color:"primary",flat:""},null,512),[[G]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(z,{modelValue:o.status,"onUpdate:modelValue":e[9]||(e[9]=a=>o.status=a),label:"\u4EFB\u52D9\u72C0\u614B",options:Y},null,8,["modelValue"]),t(z,{modelValue:o.owner,"onUpdate:modelValue":e[10]||(e[10]=a=>o.owner=a),label:"\u5C08\u6848\u4E3B\u7BA1",options:L.value},null,8,["modelValue","options"]),t($,{modelValue:o.remark,"onUpdate:modelValue":e[11]||(e[11]=a=>o.remark=a),label:"\u5099\u8A3B",type:"textarea",clearable:""},null,8,["modelValue"])]),_:1}),t(ke,{align:"right"},{default:n(()=>[N(t(c,{class:"btn-cancel",flat:"",label:"\u53D6\u6D88"},null,512),[[G]]),t(c,{class:"btn-save",flat:"",label:"\u5132\u5B58",onClick:e[12]||(e[12]=a=>ae())})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{We as default};
